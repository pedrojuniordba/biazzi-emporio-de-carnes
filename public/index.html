<script>
const API = '/api';


/* =====================================================
   PRODUCTS (OBRIGAT√ìRIO ‚Äî estava faltando ‚ùå)
===================================================== */

const PRODUCTS = [
  { val:'meat',    label:'Carne',  price:60 },
  { val:'ribs',    label:'Costela',price:55 },
  { val:'chicken', label:'Frango', price:25 }
];


/* =====================================================
   SAFE NUMBER HELPERS
===================================================== */

function toNumber(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function fixed(v,d=2){
  return toNumber(v).toFixed(d);
}

function fmt(v){
  return 'R$ ' + fixed(v,2).replace('.',',');
}


/* =====================================================
   API
===================================================== */

async function api(path, method='GET', body=null){
  const opts = {
    method,
    headers:{'Content-Type':'application/json'}
  };

  if(body) opts.body = JSON.stringify(body);

  const res = await fetch(API + path, opts);

  if(!res.ok){
    const e = await res.json().catch(()=>({}));
    throw new Error(e.error || res.statusText);
  }

  return res.json();
}


/* =====================================================
   GLOBAL STATE
===================================================== */

let orders = [];
let history = [];
let editId = null;


/* =====================================================
   ITEM ROW (ESTAVA FALTANDO ‚ùå)
===================================================== */

function addItemRow(containerId, fn){

  const container = document.getElementById(containerId);

  const row = document.createElement('div');
  row.className = 'item-row';

  row.innerHTML = `
    <select class="item-type">
      ${PRODUCTS.map(p=>`<option value="${p.val}">${p.label}</option>`).join('')}
    </select>

    <input class="item-qty" type="number" step="0.1" value="1">
    <input class="item-price" type="number" step="0.01" value="0">
    <input class="item-subtotal" readonly>
  `;

  container.appendChild(row);

  row.querySelector('.item-type').onchange = () => autoPrice(row.querySelector('.item-type'), fn);
  row.querySelector('.item-qty').oninput = window[fn];
  row.querySelector('.item-price').oninput = window[fn];
}


/* =====================================================
   PRICE AUTO FILL
===================================================== */

function autoPrice(sel, fn){
  const p = PRODUCTS.find(x => x.val === sel.value);

  if(p){
    sel.closest('.item-row')
       .querySelector('.item-price')
       .value = fixed(p.price,2);
  }

  window[fn]();
}


/* =====================================================
   SUBTOTAL CALC
===================================================== */

function calcSubtotals(containerId){

  let total = 0;

  document
    .querySelectorAll(`#${containerId} .item-row`)
    .forEach(row => {

      const qty   = toNumber(row.querySelector('.item-qty').value);
      const price = toNumber(row.querySelector('.item-price').value);

      const sub = qty * price;

      row.querySelector('.item-subtotal').value = fmt(sub);

      total += sub;
    });

  return total;
}

function calcTotal(){
  calcSubtotals('items-list');
}

function calcEditTotal(){
  calcSubtotals('e-items-list');
}


/* =====================================================
   STARTUP
===================================================== */

document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ Front carregado com sucesso');
});
</script>
