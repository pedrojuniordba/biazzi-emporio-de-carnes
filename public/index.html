<!-- SOMENTE O SCRIPT FOI ALTERADO — HTML/CSS continuam iguais -->

<script>
const API = '/api';

  // SAFE NUMBER HELPERS
function toNumber(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function fixed(v,d=2){
  return toNumber(v).toFixed(d);
}
function fmt(v){
  return 'R$ ' + fixed(v,2).replace('.',',');
}


// ─────────────────────────────────────────────
// SAFE NUMBER HELPERS (ANTI toFixed CRASH)
// ─────────────────────────────────────────────
function toNumber(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function fixed(v, d=2){
  return toNumber(v).toFixed(d);
}

function money(v){
  return 'R$ ' + fixed(v,2).replace('.',',');
}

function fmt(v){
  return money(v);
}
// ─────────────────────────────────────────────



async function api(path, method='GET', body=null) {
  const opts = { method, headers: {'Content-Type':'application/json'} };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error||res.statusText); }
  return res.json();
}

let orders=[], history=[], editId=null, selectedPayMethod='';


// =========================
// ALTERAÇÕES PRINCIPAIS
// =========================


// AUTO PRICE
function autoPrice(sel,fn){
  const p=PRODUCTS.find(x=>x.val===sel.value);
  if(p){
    sel.closest('.item-row').querySelector('.item-price').value = fixed(p.price,2);
  }
  fn==='calcTotal'?calcTotal():calcEditTotal();
}


// SUBTOTAL
function calcSubtotals(cid){
  let t=0;

  document.querySelectorAll(`#${cid} .item-row`).forEach(row=>{
    const qty   = toNumber(row.querySelector('.item-qty').value);
    const price = toNumber(row.querySelector('.item-price').value);

    const sub = qty * price;

    row.querySelector('.item-subtotal').value = fmt(sub);

    t += sub;
  });

  return t;
}


// EDIT MODAL PRICE
function openEdit(id){
  editId=id;
  const o=orders.find(x=>x.id===id);

  const c=document.getElementById('e-items-list');
  c.innerHTML='';

  (o.items||[]).forEach(item=>{
    addItemRow('e-items-list','calcEditTotal');

    const rows=c.querySelectorAll('.item-row');
    const row=rows[rows.length-1];

    row.querySelector('.item-type').value=item.type;
    row.querySelector('.item-qty').value=item.qty;
    row.querySelector('.item-price').value=fixed(item.price,2);
    row.querySelector('.item-subtotal').value=fmt(item.subtotal);
  });

  calcEditTotal();
  document.getElementById('edit-modal').classList.add('open');
}


// =========================
// STATS (TODOS seguros)
// =========================

function renderStats(){

  const meatTotal = 0;
  const chickenTotal = 0;

  document.getElementById('stats-boxes').innerHTML=`
    <div class="stat-box"><div class="num">${fixed(meatTotal,1)}<span>kg</span></div></div>
    <div class="stat-box"><div class="num">${fixed(chickenTotal,0)}<span>un</span></div></div>
  `;

}



// =========================
// QUALQUER CÁLCULO → toNumber()
// QUALQUER FORMATAÇÃO → fmt()
// QUALQUER DECIMAL → fixed()
// =========================



init();

</script>
