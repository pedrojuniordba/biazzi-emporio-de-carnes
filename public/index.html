<script>
const API = '/api';


/* =====================================================
   SAFE NUMBER HELPERS  (NUNCA MAIS toFixed crash)
===================================================== */

function toNumber(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function fixed(v,d=2){
  return toNumber(v).toFixed(d);
}

function fmt(v){
  return 'R$ ' + fixed(v,2).replace('.',',');
}


/* =====================================================
   API
===================================================== */

async function api(path, method='GET', body=null){
  const opts = {
    method,
    headers:{'Content-Type':'application/json'}
  };

  if(body) opts.body = JSON.stringify(body);

  const res = await fetch(API + path, opts);

  if(!res.ok){
    const e = await res.json().catch(()=>({}));
    throw new Error(e.error || res.statusText);
  }

  return res.json();
}


/* =====================================================
   GLOBAL STATE
===================================================== */

let orders = [];
let history = [];
let editId = null;


/* =====================================================
   PRICE AUTO FILL
===================================================== */

function autoPrice(sel, fn){

  const p = PRODUCTS.find(x => x.val === sel.value);

  if(p){
    sel.closest('.item-row')
       .querySelector('.item-price')
       .value = fixed(p.price,2);
  }

  if(fn === 'calcTotal') calcTotal();
  if(fn === 'calcEditTotal') calcEditTotal();
}


/* =====================================================
   SUBTOTAL CALC
===================================================== */

function calcSubtotals(containerId){

  let total = 0;

  document
    .querySelectorAll(`#${containerId} .item-row`)
    .forEach(row => {

      const qty   = toNumber(row.querySelector('.item-qty').value);
      const price = toNumber(row.querySelector('.item-price').value);

      const sub = qty * price;

      row.querySelector('.item-subtotal').value = fmt(sub);

      total += sub;
    });

  return total;
}


/* =====================================================
   EDIT MODAL
===================================================== */

function openEdit(id){

  editId = id;

  const o = orders.find(x => x.id === id);

  const c = document.getElementById('e-items-list');
  c.innerHTML = '';

  (o.items || []).forEach(item => {

    addItemRow('e-items-list','calcEditTotal');

    const rows = c.querySelectorAll('.item-row');
    const row = rows[rows.length-1];

    row.querySelector('.item-type').value  = item.type;
    row.querySelector('.item-qty').value   = toNumber(item.qty);
    row.querySelector('.item-price').value = fixed(item.price,2);
    row.querySelector('.item-subtotal').value = fmt(item.subtotal);
  });

  calcEditTotal();

  document
    .getElementById('edit-modal')
    .classList.add('open');
}


/* =====================================================
   STATS (SAFE)
===================================================== */

function renderStats(){

  let meatTotal = 0;
  let chickenTotal = 0;

  history.forEach(h=>{
    meatTotal    += toNumber(h.meatQty);
    chickenTotal += toNumber(h.chickenQty);
  });

  document.getElementById('stats-boxes').innerHTML = `
    <div class="stat-box">
      <div class="num">${fixed(meatTotal,1)}<span>kg</span></div>
      <div class="lbl">ğŸ¥© Carne</div>
    </div>

    <div class="stat-box">
      <div class="num">${fixed(chickenTotal,0)}<span>un</span></div>
      <div class="lbl">ğŸ— Frango</div>
    </div>
  `;
}


/* =====================================================
   STARTUP
===================================================== */

document.addEventListener('DOMContentLoaded', () => {
  console.log('App carregado âœ”');
});
</script>
